<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RealHDR - HDR Photo Editor</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }
        
        .header h1 { font-size: 2.5em; margin-bottom: 10px; }
        .header p { font-size: 1.1em; opacity: 0.9; }
        
        .upload-section { padding: 40px; }
        
        .upload-box {
            border: 3px dashed #667eea;
            border-radius: 15px;
            padding: 60px 40px;
            background: #f8f9ff;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
        }
        
        .upload-box:hover { background: #f0f2ff; border-color: #764ba2; }
        .upload-box.dragover { background: #e8ebff; transform: scale(1.02); }
        .upload-icon { font-size: 4em; margin-bottom: 20px; }
        .upload-box h3 { color: #667eea; margin-bottom: 10px; font-size: 1.5em; }
        .upload-box p { color: #666; font-size: 1.1em; }
        #fileInput { display: none; }
        
        .bracket-preview {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 20px;
            margin-top: 30px;
        }
        
        .bracket-slot {
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            padding: 20px;
            text-align: center;
            background: white;
        }
        
        .bracket-slot.filled { border-color: #667eea; background: #f8f9ff; }
        .bracket-slot img {
            width: 100%;
            height: 150px;
            object-fit: cover;
            border-radius: 5px;
            margin-bottom: 10px;
        }
        
        .bracket-label { font-weight: bold; color: #667eea; margin-bottom: 5px; }
        .bracket-status { color: #666; font-size: 0.9em; }
        
        .process-btn {
            margin-top: 30px;
            padding: 15px 50px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 25px;
            font-size: 1.2em;
            cursor: pointer;
            font-weight: 600;
            display: none;
        }
        
        .process-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }
        
        .process-btn.visible { display: inline-block; }
        
        .processing {
            padding: 40px;
            text-align: center;
            display: none;
        }
        
        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .results-section {
            padding: 40px;
            display: none;
        }
        
        .photo-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 30px;
            margin-bottom: 30px;
        }
        
        .photo-card {
            background: white;
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        
        .before-after-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 0;
        }
        
        .image-side {
            position: relative;
            height: 300px;
            overflow: hidden;
        }
        
        .image-side img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .image-label {
            position: absolute;
            top: 10px;
            left: 10px;
            background: rgba(0,0,0,0.7);
            color: white;
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 0.9em;
            font-weight: bold;
        }
        
        .photo-actions {
            padding: 20px;
            text-align: center;
        }
        
        .edit-controls {
            background: #f8f9ff;
            padding: 20px;
            border-radius: 10px;
            margin-top: 15px;
            display: none;
        }
        
        .edit-controls.active {
            display: block;
        }
        
        .prompt-section {
            margin-bottom: 20px;
        }
        
        .prompt-section h4 {
            color: #667eea;
            margin-bottom: 10px;
            font-size: 1.1em;
        }
        
        .prompt-input-group {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
        }
        
        .prompt-input {
            flex: 1;
            padding: 10px 15px;
            border: 2px solid #e0e0e0;
            border-radius: 20px;
            font-size: 0.95em;
        }
        
        .prompt-input:focus {
            outline: none;
            border-color: #667eea;
        }
        
        .quick-prompts {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }
        
        .quick-btn {
            padding: 6px 14px;
            background: white;
            border: 1px solid #e0e0e0;
            border-radius: 15px;
            font-size: 0.85em;
            cursor: pointer;
        }
        
        .quick-btn:hover {
            border-color: #667eea;
            background: #f8f9ff;
        }
        
        .sliders-section {
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid #e0e0e0;
        }
        
        .slider-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-bottom: 15px;
        }
        
        .slider-control {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }
        
        .slider-control label {
            font-size: 0.85em;
            color: #666;
            font-weight: 600;
        }
        
        .slider-control input[type="range"] {
            width: 100%;
            height: 5px;
            border-radius: 3px;
            background: #e0e0e0;
            outline: none;
        }
        
        .slider-control input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background: #667eea;
            cursor: pointer;
        }
        
        .slider-control input[type="range"]::-moz-range-thumb {
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background: #667eea;
            cursor: pointer;
            border: none;
        }
        
        .btn {
            padding: 12px 30px;
            border: none;
            border-radius: 25px;
            font-size: 1em;
            cursor: pointer;
            font-weight: 600;
            margin: 5px;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }
        
        .btn-secondary {
            background: white;
            color: #667eea;
            border: 2px solid #667eea;
        }
        
        .btn-secondary:hover {
            background: #667eea;
            color: white;
        }
        
        .stats {
            display: flex;
            justify-content: center;
            gap: 40px;
            margin: 30px 0;
            flex-wrap: wrap;
        }
        
        .stat-item { text-align: center; }
        .stat-number {
            font-size: 2.5em;
            font-weight: bold;
            color: #667eea;
        }
        .stat-label { color: #666; margin-top: 5px; }
        
        .enhancement-info {
            background: #f8f9ff;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 30px;
        }
        
        .enhancement-info h3 {
            color: #667eea;
            margin-bottom: 15px;
        }
        
        .enhancement-list {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }
        
        .enhancement-item {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .enhancement-item::before {
            content: "‚úì";
            color: #667eea;
            font-weight: bold;
            font-size: 1.2em;
        }
        
        @media (max-width: 768px) {
            .header h1 { font-size: 1.8em; }
            .photo-grid { grid-template-columns: 1fr; }
            .bracket-preview { grid-template-columns: 1fr; }
            .before-after-container { grid-template-columns: 1fr; }
            .image-side { height: 250px; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üì∏ RealHDR</h1>
            <p>Professional 3-bracket HDR merge + auto-enhancement</p>
        </div>

        <div class="upload-section" id="uploadSection">
            <div class="upload-box" id="uploadBox">
                <div class="upload-icon">‚òÅÔ∏è</div>
                <h3>Upload Your 3 Bracketed Photos</h3>
                <p>Select all 3 exposures: Underexposed, Normal, Overexposed</p>
                <p style="margin-top: 10px; font-size: 0.9em; color: #999;">
                    Drag & drop or click to browse ‚Ä¢ JPG, PNG
                </p>
            </div>
            <input type="file" id="fileInput" accept="image/*" multiple>

            <div class="bracket-preview">
                <div class="bracket-slot" id="slot1">
                    <div class="bracket-label">Underexposed (-)</div>
                    <div class="bracket-status">Waiting...</div>
                </div>
                <div class="bracket-slot" id="slot2">
                    <div class="bracket-label">Normal (0)</div>
                    <div class="bracket-status">Waiting...</div>
                </div>
                <div class="bracket-slot" id="slot3">
                    <div class="bracket-label">Overexposed (+)</div>
                    <div class="bracket-status">Waiting...</div>
                </div>
            </div>

            <div style="text-align: center;">
                <button class="process-btn" id="processBtn" onclick="processHDR()">
                    ‚ö° Merge & Enhance HDR
                </button>
            </div>
        </div>

        <div class="processing" id="processingSection">
            <div class="spinner"></div>
            <h2>Processing HDR...</h2>
            <p style="color: #666; margin-top: 10px;">Merging brackets and applying your custom enhancements</p>
        </div>

        <div class="results-section" id="resultsSection">
            <div class="enhancement-info">
                <h3>Professional HDR Enhancements Applied:</h3>
                <div class="enhancement-list">
                    <div class="enhancement-item">3-bracket HDR merge</div>
                    <div class="enhancement-item">Bright & airy exposure</div>
                    <div class="enhancement-item">High contrast S-curve</div>
                    <div class="enhancement-item">Shadow detail recovery</div>
                    <div class="enhancement-item">Highlight preservation</div>
                    <div class="enhancement-item">Enhanced blue skies</div>
                    <div class="enhancement-item">Clean white balance</div>
                    <div class="enhancement-item">Detail sharpening + clarity</div>
                </div>
            </div>

            <div class="stats">
                <div class="stat-item">
                    <div class="stat-number" id="photoCount">0</div>
                    <div class="stat-label">HDR Photos Created</div>
                </div>
                <div class="stat-item">
                    <div class="stat-number">3x</div>
                    <div class="stat-label">Bracket Merge</div>
                </div>
                <div class="stat-item">
                    <div class="stat-number">100%</div>
                    <div class="stat-label">Professional Quality</div>
                </div>
            </div>

            <div class="photo-grid" id="photoGrid"></div>

            <div style="text-align: center; margin-top: 30px; padding-top: 30px; border-top: 2px solid #f0f0f0;">
                <button class="btn btn-primary" onclick="downloadAll()">
                    üì• Download All HDR Photos
                </button>
                <button class="btn btn-secondary" onclick="reset()">
                    üîÑ Process More Photos
                </button>
            </div>
        </div>
    </div>

    <script>
        let bracketedImages = [];
        let processedImages = [];

        const uploadBox = document.getElementById('uploadBox');
        const fileInput = document.getElementById('fileInput');

        uploadBox.addEventListener('click', () => fileInput.click());

        uploadBox.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadBox.classList.add('dragover');
        });

        uploadBox.addEventListener('dragleave', () => {
            uploadBox.classList.remove('dragover');
        });

        uploadBox.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadBox.classList.remove('dragover');
            handleFiles(e.dataTransfer.files);
        });

        fileInput.addEventListener('change', (e) => {
            handleFiles(e.target.files);
        });

        function handleFiles(files) {
            if (files.length === 0) return;

            const fileArray = Array.from(files);
            bracketedImages = [];

            let loadedCount = 0;
            fileArray.forEach((file) => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const img = new Image();
                    img.onload = () => {
                        bracketedImages.push({
                            image: img,
                            name: file.name,
                            data: e.target.result
                        });
                        loadedCount++;

                        if (loadedCount <= 3) {
                            updateBracketPreview(loadedCount - 1, e.target.result);
                        }

                        if (loadedCount >= 3) {
                            document.getElementById('processBtn').classList.add('visible');
                        }
                    };
                    img.src = e.target.result;
                };
                reader.readAsDataURL(file);
            });
        }

        function updateBracketPreview(index, imageData) {
            const slot = document.getElementById(`slot${index + 1}`);
            if (slot) {
                slot.classList.add('filled');
                slot.innerHTML = `
                    <div class="bracket-label">${['Underexposed (-)', 'Normal (0)', 'Overexposed (+)'][index]}</div>
                    <img src="${imageData}">
                    <div class="bracket-status">‚úì Loaded</div>
                `;
            }
        }

        function processHDR() {
            if (bracketedImages.length < 3) {
                alert('Please upload at least 3 bracketed images!');
                return;
            }

            document.getElementById('uploadSection').style.display = 'none';
            document.getElementById('processingSection').style.display = 'block';

            processedImages = [];

            const sets = Math.floor(bracketedImages.length / 3);
            
            for (let i = 0; i < sets; i++) {
                const startIdx = i * 3;
                const hdrResult = mergeHDR(
                    bracketedImages[startIdx].image,
                    bracketedImages[startIdx + 1].image,
                    bracketedImages[startIdx + 2].image,
                    `HDR_Set_${i + 1}`
                );
                processedImages.push(hdrResult);
            }

            setTimeout(showResults, 1000);
        }

        function mergeHDR(darkImg, normalImg, brightImg, setName) {
            const canvas = document.createElement('canvas');
            canvas.width = normalImg.width;
            canvas.height = normalImg.height;
            const ctx = canvas.getContext('2d');

            const darkCanvas = createCanvas(darkImg);
            const normalCanvas = createCanvas(normalImg);
            const brightCanvas = createCanvas(brightImg);

            const darkData = darkCanvas.getContext('2d').getImageData(0, 0, canvas.width, canvas.height);
            const normalData = normalCanvas.getContext('2d').getImageData(0, 0, canvas.width, canvas.height);
            const brightData = brightCanvas.getContext('2d').getImageData(0, 0, canvas.width, canvas.height);

            const hdrData = ctx.createImageData(canvas.width, canvas.height);

            for (let i = 0; i < normalData.data.length; i += 4) {
                const normalLum = 0.299 * normalData.data[i] + 0.587 * normalData.data[i + 1] + 0.114 * normalData.data[i + 2];

                let r, g, b;

                if (normalLum < 50) {
                    // Dark areas: use bright exposure
                    r = brightData.data[i] * 0.7 + normalData.data[i] * 0.3;
                    g = brightData.data[i + 1] * 0.7 + normalData.data[i + 1] * 0.3;
                    b = brightData.data[i + 2] * 0.7 + normalData.data[i + 2] * 0.3;
                } else if (normalLum > 200) {
                    // Bright areas: use dark exposure
                    r = darkData.data[i] * 0.7 + normalData.data[i] * 0.3;
                    g = darkData.data[i + 1] * 0.7 + normalData.data[i + 1] * 0.3;
                    b = darkData.data[i + 2] * 0.7 + normalData.data[i + 2] * 0.3;
                } else {
                    // Mid-tones: blend all three
                    r = normalData.data[i] * 0.5 + darkData.data[i] * 0.25 + brightData.data[i] * 0.25;
                    g = normalData.data[i + 1] * 0.5 + darkData.data[i + 1] * 0.25 + brightData.data[i + 1] * 0.25;
                    b = normalData.data[i + 2] * 0.5 + darkData.data[i + 2] * 0.25 + brightData.data[i + 2] * 0.25;
                }

                hdrData.data[i] = r;
                hdrData.data[i + 1] = g;
                hdrData.data[i + 2] = b;
                hdrData.data[i + 3] = 255;
            }

            ctx.putImageData(hdrData, 0, 0);
            const originalHDR = canvas.toDataURL('image/jpeg', 0.95);

            const enhanced = applyEnhancements(canvas);

            return {
                original: originalHDR,
                enhanced: enhanced,
                fileName: `${setName}.jpg`
            };
        }

        function createCanvas(img) {
            const canvas = document.createElement('canvas');
            canvas.width = img.width;
            canvas.height = img.height;
            const ctx = canvas.getContext('2d');
            ctx.drawImage(img, 0, 0);
            return canvas;
        }

        function applyEnhancements(canvas) {
            const ctx = canvas.getContext('2d');
            const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
            const data = imageData.data;

            for (let i = 0; i < data.length; i += 4) {
                let r = data[i];
                let g = data[i + 1];
                let b = data[i + 2];

                const luminance = 0.299 * r + 0.587 * g + 0.114 * b;

                // HDR shadow recovery
                if (luminance < 100) {
                    const liftFactor = 1.4 - (luminance / 200);
                    r = Math.min(255, r * liftFactor);
                    g = Math.min(255, g * liftFactor);
                    b = Math.min(255, b * liftFactor);
                }

                // Highlight preservation
                if (luminance > 200) {
                    r *= 0.95;
                    g *= 0.95;
                    b *= 0.95;
                }

                // Brightness boost
                r = Math.min(255, r * 1.12);
                g = Math.min(255, g * 1.12);
                b = Math.min(255, b * 1.12);

                // High contrast
                const contrastFactor = 1.25;
                r = ((r / 255 - 0.5) * contrastFactor + 0.5) * 255;
                g = ((g / 255 - 0.5) * contrastFactor + 0.5) * 255;
                b = ((b / 255 - 0.5) * contrastFactor + 0.5) * 255;

                // Enhance blues
                if (b > r && b > g) {
                    b = Math.min(255, b * 1.15);
                    r *= 0.98;
                    g *= 0.99;
                }

                // Saturation
                const avg = (r + g + b) / 3;
                r = avg + (r - avg) * 1.18;
                g = avg + (g - avg) * 1.18;
                b = avg + (b - avg) * 1.18;

                // Cool tone
                r *= 0.99;
                b = Math.min(255, b * 1.02);

                // Clean whites
                if (r > 230 && g > 230 && b > 230) {
                    r = Math.min(255, r * 1.05);
                    g = Math.min(255, g * 1.05);
                    b = Math.min(255, b * 1.05);
                }

                data[i] = Math.max(0, Math.min(255, r));
                data[i + 1] = Math.max(0, Math.min(255, g));
                data[i + 2] = Math.max(0, Math.min(255, b));
            }

            ctx.putImageData(imageData, 0, 0);
            sharpenCanvas(ctx, canvas.width, canvas.height);
            return canvas.toDataURL('image/jpeg', 0.95);
        }

        function sharpenCanvas(ctx, width, height) {
            const imageData = ctx.getImageData(0, 0, width, height);
            const data = imageData.data;
            const tempData = new Uint8ClampedArray(data);

            for (let y = 1; y < height - 1; y++) {
                for (let x = 1; x < width - 1; x++) {
                    for (let c = 0; c < 3; c++) {
                        const idx = (y * width + x) * 4 + c;
                        const sum = tempData[idx] * 5
                            - tempData[((y - 1) * width + x) * 4 + c]
                            - tempData[((y + 1) * width + x) * 4 + c]
                            - tempData[(y * width + (x - 1)) * 4 + c]
                            - tempData[(y * width + (x + 1)) * 4 + c];
                        data[idx] = Math.max(0, Math.min(255, sum));
                    }
                }
            }

            ctx.putImageData(imageData, 0, 0);
        }

        function showResults() {
            document.getElementById('processingSection').style.display = 'none';
            document.getElementById('resultsSection').style.display = 'block';

            const photoGrid = document.getElementById('photoGrid');
            photoGrid.innerHTML = '';
            document.getElementById('photoCount').textContent = processedImages.length;

            processedImages.forEach((image, index) => {
                const card = document.createElement('div');
                card.className = 'photo-card';
                card.innerHTML = `
                    <div class="before-after-container">
                        <div class="image-side">
                            <img src="${image.original}">
                            <div class="image-label">HDR Merged</div>
                        </div>
                        <div class="image-side">
                            <img src="${image.enhanced}" id="img-${index}">
                            <div class="image-label">Enhanced</div>
                        </div>
                    </div>
                    <div class="photo-actions">
                        <button class="btn btn-primary" onclick="downloadSingle(${index})">
                            üì• Download
                        </button>
                        <button class="btn btn-secondary" onclick="toggleEdit(${index})">
                            ‚úèÔ∏è Fine-Tune
                        </button>
                    </div>
                    <div class="edit-controls" id="edit-${index}">
                        <div class="prompt-section">
                            <h4>Quick Adjustments</h4>
                            <div class="prompt-input-group">
                                <input type="text" class="prompt-input" id="prompt-${index}" 
                                       placeholder="Try: 'brighten' or 'warmer' or 'more blue'">
                                <button class="btn btn-primary" onclick="applyPrompt(${index})" style="padding: 8px 20px;">
                                    Apply
                                </button>
                            </div>
                            <div class="quick-prompts">
                                <button class="quick-btn" onclick="quickEdit(${index}, 'brighten')">‚òÄÔ∏è Brighten</button>
                                <button class="quick-btn" onclick="quickEdit(${index}, 'darken')">üåô Darken</button>
                                <button class="quick-btn" onclick="quickEdit(${index}, 'warmer')">üî• Warmer</button>
                                <button class="quick-btn" onclick="quickEdit(${index}, 'cooler')">‚ùÑÔ∏è Cooler</button>
                                <button class="quick-btn" onclick="quickEdit(${index}, 'blue')">üåä More Blue</button>
                                <button class="quick-btn" onclick="quickEdit(${index}, 'shadows')">üí° Lift Shadows</button>
                            </div>
                        </div>
                        
                        <div class="sliders-section">
                            <h4 style="color: #667eea; margin-bottom: 10px; font-size: 1.1em;">Manual Controls</h4>
                            <div class="slider-row">
                                <div class="slider-control">
                                    <label>Brightness</label>
                                    <input type="range" min="-50" max="50" value="0" 
                                           oninput="applySlider(${index}, 'brightness', this.value)">
                                </div>
                                <div class="slider-control">
                                    <label>Contrast</label>
                                    <input type="range" min="-50" max="50" value="0" 
                                           oninput="applySlider(${index}, 'contrast', this.value)">
                                </div>
                                <div class="slider-control">
                                    <label>Saturation</label>
                                    <input type="range" min="-50" max="50" value="0" 
                                           oninput="applySlider(${index}, 'saturation', this.value)">
                                </div>
                                <div class="slider-control">
                                    <label>Warmth</label>
                                    <input type="range" min="-50" max="50" value="0" 
                                           oninput="applySlider(${index}, 'warmth', this.value)">
                                </div>
                            </div>
                            <div style="text-align: center; margin-top: 15px;">
                                <button class="btn btn-secondary" onclick="resetImage(${index})" style="padding: 8px 20px;">
                                    üîÑ Reset
                                </button>
                            </div>
                        </div>
                    </div>
                `;
                photoGrid.appendChild(card);
            });
        }

        function downloadSingle(index) {
            const link = document.createElement('a');
            link.href = processedImages[index].enhanced;
            link.download = processedImages[index].fileName;
            link.click();
        }

        function toggleEdit(index) {
            const editPanel = document.getElementById(`edit-${index}`);
            editPanel.classList.toggle('active');
        }

        function quickEdit(index, type) {
            const prompts = {
                'brighten': 'brighten overall',
                'darken': 'darken overall',
                'warmer': 'warmer tones',
                'cooler': 'cooler tones',
                'blue': 'more blue sky',
                'shadows': 'lift shadows'
            };
            document.getElementById(`prompt-${index}`).value = prompts[type];
            applyPrompt(index);
        }

        function applyPrompt(index) {
            const prompt = document.getElementById(`prompt-${index}`).value.toLowerCase();
            if (!prompt) return;

            if (!processedImages[index].backup) {
                processedImages[index].backup = processedImages[index].enhanced;
            }

            const img = new Image();
            img.onload = () => {
                const canvas = createCanvas(img);
                const ctx = canvas.getContext('2d');
                const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                const data = imageData.data;

                if (prompt.includes('brighten') || prompt.includes('lighter')) {
                    for (let i = 0; i < data.length; i += 4) {
                        data[i] = Math.min(255, data[i] * 1.2);
                        data[i + 1] = Math.min(255, data[i + 1] * 1.2);
                        data[i + 2] = Math.min(255, data[i + 2] * 1.2);
                    }
                }

                if (prompt.includes('darken') || prompt.includes('darker')) {
                    for (let i = 0; i < data.length; i += 4) {
                        data[i] *= 0.85;
                        data[i + 1] *= 0.85;
                        data[i + 2] *= 0.85;
                    }
                }

                if (prompt.includes('warm')) {
                    for (let i = 0; i < data.length; i += 4) {
                        data[i] = Math.min(255, data[i] * 1.1);
                        data[i + 1] = Math.min(255, data[i + 1] * 1.05);
                        data[i + 2] *= 0.95;
                    }
                }

                if (prompt.includes('cool') || prompt.includes('cold')) {
                    for (let i = 0; i < data.length; i += 4) {
                        data[i] *= 0.95;
                        data[i + 2] = Math.min(255, data[i + 2] * 1.1);
                    }
                }

                if (prompt.includes('blue') || prompt.includes('sky')) {
                    for (let i = 0; i < data.length; i += 4) {
                        if (data[i + 2] > data[i] && data[i + 2] > data[i + 1]) {
                            data[i + 2] = Math.min(255, data[i + 2] * 1.3);
                            data[i] *= 0.9;
                        }
                    }
                }

                if (prompt.includes('shadow')) {
                    for (let i = 0; i < data.length; i += 4) {
                        const lum = 0.299 * data[i] + 0.587 * data[i + 1] + 0.114 * data[i + 2];
                        if (lum < 100) {
                            data[i] = Math.min(255, data[i] * 1.3);
                            data[i + 1] = Math.min(255, data[i + 1] * 1.3);
                            data[i + 2] = Math.min(255, data[i + 2] * 1.3);
                        }
                    }
                }

                if (prompt.includes('contrast')) {
                    for (let i = 0; i < data.length; i += 4) {
                        data[i] = ((data[i] / 255 - 0.5) * 1.3 + 0.5) * 255;
                        data[i + 1] = ((data[i + 1] / 255 - 0.5) * 1.3 + 0.5) * 255;
                        data[i + 2] = ((data[i + 2] / 255 - 0.5) * 1.3 + 0.5) * 255;
                    }
                }

                ctx.putImageData(imageData, 0, 0);
                const newUrl = canvas.toDataURL('image/jpeg', 0.95);
                processedImages[index].enhanced = newUrl;
                document.getElementById(`img-${index}`).src = newUrl;
            };
            img.src = processedImages[index].enhanced;
        }

        function applySlider(index, type, value) {
            if (!processedImages[index].backup) {
                processedImages[index].backup = processedImages[index].enhanced;
            }

            const img = new Image();
            img.onload = () => {
                const canvas = createCanvas(img);
                const ctx = canvas.getContext('2d');
                const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                const data = imageData.data;

                const val = parseFloat(value);

                if (type === 'brightness') {
                    const factor = 1 + (val / 100);
                    for (let i = 0; i < data.length; i += 4) {
                        data[i] = Math.min(255, Math.max(0, data[i] * factor));
                        data[i + 1] = Math.min(255, Math.max(0, data[i + 1] * factor));
                        data[i + 2] = Math.min(255, Math.max(0, data[i + 2] * factor));
                    }
                }

                if (type === 'contrast') {
                    const factor = 1 + (val / 100);
                    for (let i = 0; i < data.length; i += 4) {
                        data[i] = Math.min(255, Math.max(0, ((data[i] / 255 - 0.5) * factor + 0.5) * 255));
                        data[i + 1] = Math.min(255, Math.max(0, ((data[i + 1] / 255 - 0.5) * factor + 0.5) * 255));
                        data[i + 2] = Math.min(255, Math.max(0, ((data[i + 2] / 255 - 0.5) * factor + 0.5) * 255));
                    }
                }

                if (type === 'saturation') {
                    const factor = 1 + (val / 100);
                    for (let i = 0; i < data.length; i += 4) {
                        const avg = (data[i] + data[i + 1] + data[i + 2]) / 3;
                        data[i] = Math.min(255, Math.max(0, avg + (data[i] - avg) * factor));
                        data[i + 1] = Math.min(255, Math.max(0, avg + (data[i + 1] - avg) * factor));
                        data[i + 2] = Math.min(255, Math.max(0, avg + (data[i + 2] - avg) * factor));
                    }
                }

                if (type === 'warmth') {
                    const factor = val / 100;
                    for (let i = 0; i < data.length; i += 4) {
                        data[i] = Math.min(255, Math.max(0, data[i] * (1 + factor * 0.2)));
                        data[i + 1] = Math.min(255, Math.max(0, data[i + 1] * (1 + factor * 0.1)));
                        data[i + 2] = Math.min(255, Math.max(0, data[i + 2] * (1 - factor * 0.2)));
                    }
                }

                ctx.putImageData(imageData, 0, 0);
                const newUrl = canvas.toDataURL('image/jpeg', 0.95);
                processedImages[index].enhanced = newUrl;
                document.getElementById(`img-${index}`).src = newUrl;
            };
            img.src = processedImages[index].backup;
        }

        function resetImage(index) {
            if (processedImages[index].backup) {
                processedImages[index].enhanced = processedImages[index].backup;
                document.getElementById(`img-${index}`).src = processedImages[index].backup;
            }
            
            const sliders = document.querySelectorAll(`#edit-${index} input[type="range"]`);
            sliders.forEach(s => s.value = 0);
            document.getElementById(`prompt-${index}`).value = '';
        }

        function downloadAll() {
            processedImages.forEach((image, index) => {
                setTimeout(() => {
                    const link = document.createElement('a');
                    link.href = image.enhanced;
                    link.download = image.fileName;
                    link.click();
                }, index * 200);
            });
        }

        function reset() {
            document.getElementById('resultsSection').style.display = 'none';
            document.getElementById('uploadSection').style.display = 'block';
            bracketedImages = [];
            processedImages = [];
            fileInput.value = '';
            document.getElementById('processBtn').classList.remove('visible');
            
            for (let i = 1; i <= 3; i++) {
                const slot = document.getElementById(`slot${i}`);
                slot.classList.remove('filled');
                slot.innerHTML = `
                    <div class="bracket-label">${['Underexposed (-)', 'Normal (0)', 'Overexposed (+)'][i-1]}</div>
                    <div class="bracket-status">Waiting...</div>
                `;
            }
        }
    </script>
</body>
</html>
